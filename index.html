<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clue Solver - Glassmorphism Edition</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f0f2f5;
            /* Prominent Glass Settings */
            --card-bg: rgba(255, 255, 255, 0.45);
            --header-bg: rgba(255, 255, 255, 0.3);
            --border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(24px);
            
            --text-main: #0f172a;
            --text-muted: #475569;
            --radius: 20px;
            --radius-sm: 12px;
            --safe-bottom: env(safe-area-inset-bottom, 16px);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body.dark-mode {
            --bg: #020617;
            --card-bg: rgba(15, 23, 42, 0.5);
            --header-bg: rgba(15, 23, 42, 0.3);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.15);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        }

        /* Enhanced Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background: linear-gradient(125deg, #e0e7ff 0%, #f1f5f9 50%, #fdf4ff 100%);
            transition: background 0.4s ease;
        }

        body.dark-mode::before {
            background: linear-gradient(125deg, #020617 0%, #0f172a 50%, #1e1b4b 100%);
        }

        /* Floating Blobs for Glass Depth */
        .bg-blobs {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .blob {
            position: absolute;
            width: 50vw;
            height: 50vw;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.25) 0%, transparent 70%);
            filter: blur(40px);
            border-radius: 50%;
            animation: float 25s infinite alternate ease-in-out;
        }

        .blob-1 { top: -10%; left: -10%; background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, transparent 70%); }
        .blob-2 { bottom: -10%; right: -10%; background: radial-gradient(circle, rgba(236, 72, 153, 0.25) 0%, transparent 70%); animation-delay: -5s; }
        .blob-3 { top: 40%; right: 10%; width: 30vw; height: 30vw; background: radial-gradient(circle, rgba(34, 197, 94, 0.2) 0%, transparent 70%); animation-delay: -12s; }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(20vw, 20vh) scale(1.2); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes iconPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-in { animation: fadeInUp 0.4s var(--spring); }
        .icon-pop { animation: iconPop 0.2s var(--spring); }

        * { 
            box-sizing: border-box; 
            margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
            line-height: 1.4;
            padding-bottom: calc(70px + var(--safe-bottom));
            font-size: 15px; 
            min-height: 100vh;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 8px; }
        @media (min-width: 768px) { .container { padding: 24px; } }

        .hidden { display: none !important; }
        
        .card { 
            background: var(--card-bg); 
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--radius); 
            border: 1px solid var(--border); 
            padding: 14px; 
            margin-bottom: 12px; 
            box-shadow: var(--shadow); 
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s var(--spring);
        }

        h1, h2, h3 { font-weight: 800; letter-spacing: -0.03em; }
        
        button { 
            cursor: pointer; 
            border: none; 
            font-weight: 700; 
            transition: all 0.25s var(--spring); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            overflow: hidden;
        }
        button:active { transform: scale(0.92); opacity: 0.8; }
        
        .setup-header { text-align: center; margin-bottom: 20px; padding: 5px; position: relative; }
        .setup-header h1 { font-size: 1.75rem; color: var(--text-main); background: linear-gradient(135deg, var(--primary), #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .setup-header p { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; margin-top: 2px; }

        .theme-toggle-btn {
            position: absolute; top: 5px; right: 5px;
            background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main);
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
        }
        .theme-toggle-btn .material-icons { font-size: 18px; transition: transform 0.4s var(--spring); }
        .theme-toggle-btn:active .material-icons { transform: rotate(180deg); }

        .form-section { margin-bottom: 24px; }
        .form-section h2 { font-size: 1.1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
        
        .player-inputs { display: grid; grid-template-columns: 1fr; gap: 8px; }
        @media (min-width: 640px) { .player-inputs { grid-template-columns: repeat(2, 1fr); } }
        
        .player-input-row { 
            background: rgba(255, 255, 255, 0.15); border: 1px solid var(--border); padding: 8px 10px; border-radius: var(--radius-sm); 
            display: flex; gap: 8px; align-items: center; transition: background-color 0.2s;
        }
        body.dark-mode .player-input-row { background: rgba(0, 0, 0, 0.2); }
        .player-input-row input[type="text"] { background: transparent; border: none; font-weight: 700; outline: none; flex: 1; min-width: 0; font-size: 15px; color: var(--text-main); }
        .player-input-row input[type="number"] { width: 40px; border: 1px solid var(--border); border-radius: 6px; padding: 4px; font-weight: 800; text-align: center; font-size: 13px; background: rgba(255, 255, 255, 0.15); color: var(--text-main); }
        .player-badge { background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .player-badge .material-icons { font-size: 16px; }
        
        .btn-remove-player { background: rgba(239, 68, 68, 0.15); color: var(--danger); width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s var(--spring); }
        .btn-remove-player .material-icons { font-size: 18px; }

        .label-small { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px; }
        .card-pill { 
            padding: 10px 8px; border-radius: 12px; background: rgba(255, 255, 255, 0.15); 
            border: 1px solid var(--border); font-size: 12px; font-weight: 700; text-align: center; 
            color: var(--text-main); transition: all 0.25s var(--spring);
        }
        body.dark-mode .card-pill { background: rgba(0, 0, 0, 0.2); }
        .card-pill.selected { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }

        .btn-start { width: 100%; padding: 16px; background: var(--text-main); color: var(--bg); border-radius: var(--radius); font-size: 1rem; margin-top: 16px; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }

        /* Navigation Tabs */
        .nav-tabs { 
            display: flex; gap: 4px; margin-bottom: 12px; background: var(--header-bg); padding: 4px; border-radius: 14px; 
            position: sticky; top: 8px; z-index: 100; box-shadow: var(--shadow);
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: 1px solid var(--border);
        }
        .tab-btn { 
            flex: 1; padding: 10px 4px; border-radius: 10px; background: transparent; 
            color: var(--text-muted); font-size: 12px; font-weight: 800; text-align: center; 
            white-space: nowrap; transition: all 0.3s var(--spring);
        }
        .tab-btn.active { background: var(--card-bg); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transform: translateY(-1px); border: 1px solid var(--border); }

        /* Floating Action Button (FAB) */
        .fab {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 18px;
            background: var(--primary);
            color: white;
            box-shadow: 0 12px 24px -6px rgba(99, 102, 241, 0.5);
            z-index: 200;
            display: none;
            cursor: pointer;
            border: none;
            transition: all 0.3s var(--spring);
        }
        .fab:active { transform: scale(0.85); box-shadow: 0 4px 12px -4px rgba(99, 102, 241, 0.5); }
        .fab .material-icons { font-size: 32px; }

        @media (max-width: 640px) {
            #tabBtnNew { display: none !important; }
            .fab { display: flex !important; }
        }

        /* Assistant */
        .assistant-box { background: rgba(255, 251, 235, 0.4); border: 1px solid rgba(253, 230, 138, 0.5); border-radius: var(--radius-sm); padding: 12px 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; backdrop-filter: var(--glass-blur); transition: all 0.3s; }
        .assistant-box.my-turn { background: rgba(239, 246, 255, 0.4); border-color: rgba(191, 219, 254, 0.5); }
        body.dark-mode .assistant-box { background: rgba(69, 26, 3, 0.3); border-color: rgba(146, 64, 14, 0.2); }
        body.dark-mode .assistant-box.my-turn { background: rgba(30, 58, 138, 0.3); border-color: rgba(37, 99, 235, 0.2); }
        
        .assistant-content h4 { font-size: 9px; text-transform: uppercase; color: #b45309; letter-spacing: 0.1em; margin-bottom: 4px; }
        body.dark-mode .assistant-content h4 { color: #fcd34d; }
        body.dark-mode .assistant-box.my-turn h4 { color: #93c5fd; }

        .sugg-chip { background: rgba(254, 243, 199, 0.5); padding: 4px 10px; border-radius: 8px; font-size: 13px; border: 1px solid rgba(253, 230, 138, 0.3); font-weight: 800; color: #92400e; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .assistant-box.my-turn .sugg-chip { background: rgba(219, 234, 254, 0.5); border-color: rgba(191, 219, 254, 0.3); color: #1e40af; }

        .turn-card { background: rgba(238, 242, 255, 0.4); border: 1px solid rgba(199, 210, 254, 0.4); padding: 10px 14px; border-radius: var(--radius-sm); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; backdrop-filter: var(--glass-blur); transition: background-color 0.3s; }
        body.dark-mode .turn-card { background: rgba(30, 27, 75, 0.4); border-color: rgba(49, 46, 129, 0.4); }
        .turn-label { font-size: 10px; font-weight: 900; color: var(--primary); text-transform: uppercase; }
        .turn-name { font-weight: 800; color: #1e1b4b; font-size: 1.1rem; }
        body.dark-mode .turn-name { color: #e0e7ff; }

        .solution-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px; }
        .solution-card { padding: 8px 4px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); backdrop-filter: var(--glass-blur); display: flex; flex-direction: column; align-items: center; transition: all 0.4s var(--spring); }
        .solution-card.found { border-color: var(--success); background: rgba(236, 253, 245, 0.5); transform: scale(1.05); }
        body.dark-mode .solution-card.found { background: rgba(6, 78, 59, 0.5); }
        .solution-label { font-size: 8px; font-weight: 900; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
        .solution-value { font-size: 0.9rem; font-weight: 800; color: var(--text-main); text-align: center; }
        .solution-card.found .solution-value { color: #065f46; }
        body.dark-mode .solution-card.found .solution-value { color: #34d399; }

        /* Compact Glass Table */
        .table-wrap { 
            overflow-x: auto; background: var(--card-bg); backdrop-filter: var(--glass-blur); border-radius: var(--radius-sm); border: 1px solid var(--border); 
            -webkit-overflow-scrolling: touch; position: relative; box-shadow: var(--shadow);
        }
        table { width: 100%; border-collapse: collapse; text-align: left; table-layout: fixed; }
        th, td { padding: 8px 6px; border-bottom: 1px solid var(--border); font-size: 13px; min-width: 55px; color: var(--text-main); transition: background-color 0.2s; }
        th:first-child, td:first-child { 
            min-width: 110px; width: 120px; position: sticky; left: 0; background: var(--card-bg); z-index: 10;
            border-right: 1px solid var(--border); font-weight: 700; transition: background-color 0.2s;
        }
        th:first-child { z-index: 20; background: var(--header-bg); }
        th { background: var(--header-bg); font-weight: 800; color: var(--text-muted); font-size: 10px; text-transform: uppercase; }

        .header-cell-content { display: flex; flex-direction: column; align-items: center; }
        .header-edit { 
            background: transparent; border: none; font-family: inherit; font-weight: 900; color: var(--text-main); 
            font-size: 10px; text-transform: uppercase; width: 100%; text-align: center; padding: 2px 0; outline: none;
            transition: all 0.2s;
        }
        .header-edit:focus { background: rgba(99, 102, 241, 0.1); border-radius: 4px; }
        .card-count-indicator { font-size: 9px; color: var(--text-muted); font-weight: 700; }

        .category-row { background: var(--header-bg); font-weight: 900; font-size: 9px; text-transform: uppercase; color: var(--primary); }
        .category-row td { padding: 4px 10px; }

        .deduction-cell { cursor: pointer; user-select: none; transition: background 0.1s var(--spring); }
        .deduction-cell:active { background: rgba(0, 0, 0, 0.08); }
        .cell-yes { color: var(--success); text-align: center; }
        .cell-yes .material-icons { font-size: 20px; animation: iconPop 0.25s var(--spring); }
        .cell-no { color: var(--danger); text-align: center; opacity: 0.35; }
        .cell-no .material-icons { font-size: 16px; animation: iconPop 0.25s var(--spring); }
        .cell-unknown { text-align: center; color: #cbd5e1; }
        .cell-unknown .material-icons { font-size: 16px; }
        
        .manual-yes { background: rgba(16, 185, 129, 0.1) !important; box-shadow: inset 0 0 0 1px var(--success); }
        .manual-no { background: rgba(239, 68, 68, 0.1) !important; box-shadow: inset 0 0 0 1px var(--danger); }

        .row-found { background-color: rgba(16, 185, 129, 0.05) !important; }
        .row-found td:first-child { color: #059669 !important; background-color: rgba(16, 185, 129, 0.05) !important; }
        .row-recommended { background-color: rgba(99, 102, 241, 0.05) !important; }
        .row-recommended td:first-child { color: #2563eb !important; border-left: 4px solid var(--primary); background-color: rgba(99, 102, 241, 0.05) !important; }

        /* Tag-Style Form Controls */
        .select-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .btn-option { 
            padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.1); 
            font-size: 12px; text-align: center; font-weight: 700; display: flex; align-items: center; justify-content: center; 
            min-height: 38px; color: var(--text-muted); transition: all 0.2s var(--spring); flex: 1 0 auto; max-width: calc(50% - 3px);
        }
        body.dark-mode .btn-option { background: rgba(0, 0, 0, 0.15); }
        @media (min-width: 480px) { .btn-option { max-width: calc(33.333% - 4px); } }
        .btn-option.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(99, 102, 241, 0.25); transform: translateY(-1px); }

        /* Logs Tab Styling */
        .log-item { 
            background: var(--card-bg); backdrop-filter: var(--glass-blur); padding: 12px; border-radius: 16px; border: 1px solid var(--border); 
            margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; box-shadow: var(--shadow);
            transition: all 0.3s var(--spring);
        }
        .log-header { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; gap: 10px; }
        .log-who { font-weight: 800; font-size: 13px; color: var(--text-main); }
        .log-timestamp { font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }
        .log-tag-group { display: flex; flex-wrap: wrap; gap: 4px; margin: 2px 0; }
        .log-badge { font-size: 10px; padding: 4px 10px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; color: var(--text-muted); font-weight: 800; border: 1px solid var(--border); }
        .log-result { font-size: 12px; color: var(--primary); font-weight: 800; background: rgba(99, 102, 241, 0.1); padding: 8px 12px; border-radius: 10px; align-self: flex-start; border: 1px solid var(--border); }

        .log-actions { display: flex; gap: 6px; }
        .btn-log-action { width: 32px; height: 32px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); color: var(--text-muted); display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--spring); }
        .btn-log-action .material-icons { font-size: 18px; }
        .btn-log-action.delete { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        #syncIndicator { 
            position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); 
            font-size: 10px; font-weight: 900; color: var(--text-muted); background: var(--card-bg); 
            padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; z-index: 1000; 
            text-transform: uppercase; backdrop-filter: var(--glass-blur);
            transition: transform 0.3s var(--spring), opacity 0.3s;
        }
        .syncing-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; }
        .syncing .syncing-dot { background: var(--primary); animation: pulse 1s infinite alternate; }
    </style>
</head>
<body class="">

<div class="bg-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
</div>

<div class="container" id="app">
    <!-- SETUP VIEW -->
    <div id="setupView" class="animate-in">
        <header class="setup-header">
            <button class="theme-toggle-btn" onclick="window.toggleTheme()" title="Toggle Theme">
                <span class="material-icons">brightness_medium</span>
            </button>
            <h1>CLUE SOLVER</h1>
            <p>Glassmorphism Assistant</p>
        </header>
        <div class="card">
            <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h2>Investigation Team</h2>
                    <span class="label-small">Cards</span>
                </div>
                <div class="player-inputs" id="playerInputsContainer"></div>
                <button onclick="window.addPlayerInput()" style="margin-top:16px; background:none; color:var(--primary); font-size: 14px; font-weight: 800;">
                    <span class="material-icons" style="font-size: 16px; margin-right: 4px;">add_circle</span> ADD PLAYER
                </button>
            </div>
            <div class="form-section">
                <h2>Your Hand</h2>
                <div id="setupCardsGrid" class="card-grid"></div>
            </div>
            <button class="btn-start" onclick="window.startGame()">Initialize Solver</button>
        </div>
    </div>

    <!-- PLAY VIEW -->
    <div id="playView" class="hidden">
        <div class="nav-tabs">
            <button class="tab-btn active" id="tabBtnBoard" onclick="window.switchTab('BOARD')">ANALYSIS</button>
            <button class="tab-btn" id="tabBtnLog" onclick="window.switchTab('LOG')">LOGS</button>
            <button class="tab-btn" id="tabBtnNew" onclick="window.switchTab('NEW')">+ ASK</button>
            <button class="tab-btn" onclick="window.toggleTheme()" style="flex: 0 0 40px; padding: 0;">
                <span class="material-icons">brightness_medium</span>
            </button>
            <button class="tab-btn" onclick="window.resetGame()" style="color:var(--danger); flex: 0 1 auto; padding: 0 8px;">RESET</button>
        </div>

        <div id="tab-BOARD" class="animate-in">
            <div class="turn-card">
                <div class="turn-info">
                    <div class="turn-dot" id="turnStatusDot"></div>
                    <div>
                        <div class="turn-label">Current Turn</div>
                        <div class="turn-name" id="currentTurnNameDisplay">Name</div>
                    </div>
                </div>
                <div style="display: flex; gap: 6px;">
                    <button class="btn-icon-action" onclick="window.adjustTurn(-1)" title="Prev" style="padding: 8px 12px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: var(--text-main); height: 38px;">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <button class="btn-icon-action" onclick="window.adjustTurn(1)" title="Next" style="padding: 8px 12px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: var(--text-main); height: 38px;">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
            </div>

            <div id="recommendationBox" class="assistant-box">
                <div class="assistant-icon">
                    <span class="material-icons">lightbulb</span>
                </div>
                <div class="assistant-content">
                    <h4 id="recommendationHeader">Strategic Inquiry</h4>
                    <div id="recommendationText" class="assistant-suggestion">Calculating...</div>
                </div>
            </div>
            <div class="solution-grid" id="solutionBanner"></div>
            <div class="table-wrap">
                <table id="deductionTable">
                    <thead><tr id="tableHeader"></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <p style="font-size: 10px; color: var(--text-muted); text-align: center; margin-top: 10px; font-weight: 600;">
                ðŸ’¡ Tap cells to toggle manual overrides (âœ” / x)
            </p>
        </div>

        <div id="tab-LOG" class="hidden animate-in">
            <div id="logContainer"></div>
        </div>

        <div id="tab-NEW" class="hidden animate-in">
            <div class="card">
                <div class="form-group">
                    <label>Inquirer</label>
                    <div id="suggesterOptions" class="select-grid"></div>
                </div>
                <div id="inquirySection">
                    <div class="form-group">
                        <label>Suspect</label>
                        <div id="suspectOptions" class="select-grid"></div>
                    </div>
                    <div class="form-group">
                        <label>Weapon</label>
                        <div id="weaponOptions" class="select-grid"></div>
                    </div>
                    <div class="form-group">
                        <label>Room</label>
                        <div id="roomOptions" class="select-grid"></div>
                    </div>
                    <div class="form-group">
                        <label>Reveal Outcome</label>
                        <div id="showerOptions" class="select-grid"></div>
                    </div>
                    <div id="specificCardSection" class="form-group hidden animate-in">
                        <label>Which card was revealed to you?</label>
                        <div id="shownCardOptions" class="select-grid"></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-start" id="submitBtn" onclick="window.submitSuggestion()">Log Result</button>
                    <button class="btn-start" id="skipTurnBtn" onclick="window.skipTurn()" style="background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: var(--text-muted);">Pass</button>
                </div>
                <button class="btn-start hidden" id="cancelEditBtn" onclick="window.cancelEdit()" style="background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: var(--text-muted); margin-top: 10px;">Abort Edit</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button for Mobile -->
<button class="fab animate-in" onclick="window.switchTab('NEW')" id="mobileFab">
    <span class="material-icons">add</span>
</button>

<div id="syncIndicator">
    <div class="syncing-dot"></div>
    <span id="syncText">Saved</span>
</div>

<script type="module">
    // --- State Management ---
    let players = []; 
    let myCards = []; 
    let suggestions = []; 
    let manualOverrides = {}; 
    let gameDeductionMatrix = {}; 
    let gameState = 'SETUP';
    let currentTurnIdx = 0;
    let isInitialLoad = true;
    let theme = 'light';
    let tempSugg = { suggesterId: null, suspect: '', weapon: '', room: '', showerId: -1, cardShown: '', type: 'SUGGESTION' };
    let editingIndex = null;

    const STORAGE_KEY = 'clue_solver_glass_v1';

    const CATEGORIES = {
        SUSPECTS: ['Miss Scarlett', 'Colonel Mustard', 'Dr. Orchid', 'Mr. Green', 'Mrs. Peacock', 'Professor Plum'],
        WEAPONS: ['Candlestick', 'Dagger', 'Lead Pipe', 'Revolver', 'Rope', 'Wrench'],
        ROOMS: ['Kitchen', 'Ballroom', 'Conservatory', 'Billiard Room', 'Library', 'Study', 'Hall', 'Lounge', 'Dining Room']
    };
    const ALL_CARDS = [...CATEGORIES.SUSPECTS, ...CATEGORIES.WEAPONS, ...CATEGORIES.ROOMS];

    // --- Persistence ---
    function saveState() {
        const data = { players, myCards, suggestions, manualOverrides, gameState, currentTurnIdx, theme, timestamp: Date.now() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        const indicator = document.getElementById('syncIndicator');
        if (indicator) {
            indicator.classList.add('syncing');
            setTimeout(() => indicator.classList.remove('syncing'), 600);
        }
    }

    function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
            try {
                const d = JSON.parse(raw);
                players = d.players || [];
                myCards = d.myCards || [];
                suggestions = d.suggestions || [];
                manualOverrides = d.manualOverrides || {};
                gameState = d.gameState || 'SETUP';
                currentTurnIdx = d.currentTurnIdx || 0;
                theme = d.theme || 'light';
                document.body.classList.toggle('dark-mode', theme === 'dark');
            } catch (e) { console.error("Persistence error", e); }
        }
        isInitialLoad = false;
        render();
    }

    let saveTimeout;
    function triggerSave() { 
        if (isInitialLoad) return;
        clearTimeout(saveTimeout); 
        saveTimeout = setTimeout(saveState, 500); 
    }

    // --- Handlers ---
    window.toggleTheme = () => {
        theme = theme === 'light' ? 'dark' : 'light';
        document.body.classList.toggle('dark-mode', theme === 'dark');
        triggerSave();
    };

    window.setSuggVal = (k, v) => { 
        tempSugg[k] = v; 
        if (k === 'showerId') tempSugg.cardShown = '';
        window.updateFormSelection(); 
    };
    
    window.syncSetupToState = () => {
        const rows = document.querySelectorAll('.player-input-row');
        players = Array.from(rows).map(r => ({
            id: String(r.dataset.playerId),
            name: r.querySelector('input[type="text"]').value,
            cardCount: parseInt(r.querySelector('input[type="number"]').value) || 6
        }));
        triggerSave();
    };

    window.addPlayerInput = (n='', c=6, existingId=null) => {
        const cont = document.getElementById('playerInputsContainer');
        if (!cont) return;
        const id = existingId !== null ? String(existingId) : String(Date.now() + Math.random());
        const div = document.createElement('div');
        div.className = 'player-input-row animate-in';
        div.dataset.playerId = id;
        div.innerHTML = `
            <div class="player-badge"><span class="material-icons">person</span></div>
            <input type="text" placeholder="Name" value="${n||'Player'}" oninput="window.syncSetupToState()">
            <input type="number" value="${c}" min="1" oninput="window.syncSetupToState()">
            <button class="btn-remove-player" onclick="this.parentElement.remove(); window.syncSetupToState();">
                <span class="material-icons">remove_circle</span>
            </button>
        `;
        cont.appendChild(div);
        if (existingId === null) window.syncSetupToState();
    };

    window.startGame = () => {
        window.syncSetupToState();
        if (players.length < 2) return alert("Add at least 2 players.");
        gameState = 'PLAYING'; currentTurnIdx = 0; triggerSave(); render();
    };

    window.switchTab = (t) => {
        const tabs = ['BOARD', 'LOG', 'NEW'];
        tabs.forEach(id => {
            const el = document.getElementById('tab-' + id);
            if (el) {
                el.classList.toggle('hidden', id !== t);
                if (id === t) {
                    el.classList.remove('animate-in');
                    void el.offsetWidth; // Trigger reflow
                    el.classList.add('animate-in');
                }
            }
        });
        ['tabBtnBoard', 'tabBtnLog', 'tabBtnNew'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('active', id.includes(t.charAt(0) + t.slice(1).toLowerCase()));
        });
        
        const fab = document.getElementById('mobileFab');
        if (fab) {
            fab.style.transform = (t === 'NEW' || gameState === 'SETUP') ? 'scale(0)' : 'scale(1)';
            fab.style.pointerEvents = (t === 'NEW' || gameState === 'SETUP') ? 'none' : 'auto';
        }

        if (t === 'NEW' && editingIndex === null) {
            tempSugg.suggesterId = players[currentTurnIdx]?.id || null;
            const rec = getRecommendation();
            tempSugg.suspect = rec.suspect || CATEGORIES.SUSPECTS[0];
            tempSugg.weapon = rec.weapon || CATEGORIES.WEAPONS[0];
            tempSugg.room = rec.room || CATEGORIES.ROOMS[0];
            window.updateFormSelection();
        }
    };

    window.adjustTurn = (delta) => {
        currentTurnIdx = (currentTurnIdx + delta + players.length) % players.length;
        render(); triggerSave();
    };

    window.toggleManualOverride = (cardName, playerId) => {
        if (!manualOverrides[cardName]) manualOverrides[cardName] = {};
        const cur = manualOverrides[cardName][playerId] || 0;
        let next = 0;
        if (cur === 0) next = 1;
        else if (cur === 1) next = -1;
        else next = 0;
        
        if (next === 0) delete manualOverrides[cardName][playerId];
        else manualOverrides[cardName][playerId] = next;
        triggerSave(); render();
    };

    window.submitSuggestion = () => {
        const s = { ...tempSugg, timestamp: Date.now() };
        if (editingIndex !== null) { suggestions[editingIndex] = s; editingIndex = null; }
        else { suggestions.push(s); currentTurnIdx = (currentTurnIdx + 1) % players.length; }
        triggerSave(); render(); window.switchTab('BOARD');
        tempSugg = { suggesterId: players[currentTurnIdx]?.id || null, suspect: '', weapon: '', room: '', showerId: -1, cardShown: '', type: 'SUGGESTION' };
        document.getElementById('cancelEditBtn').classList.add('hidden');
        document.getElementById('submitBtn').innerText = 'Log Result';
    };

    window.skipTurn = () => {
        suggestions.push({ type: 'SKIP', suggesterId: players[currentTurnIdx].id, timestamp: Date.now() });
        currentTurnIdx = (currentTurnIdx + 1) % players.length;
        triggerSave(); render(); window.switchTab('BOARD');
    };

    window.editSuggestion = (index) => {
        editingIndex = index;
        const s = suggestions[index];
        tempSugg = { ...s };
        window.switchTab('NEW');
        document.getElementById('submitBtn').innerText = 'Update';
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        window.updateFormSelection();
    };

    window.cancelEdit = () => {
        editingIndex = null;
        tempSugg = { suggesterId: players[currentTurnIdx]?.id || null, suspect: '', weapon: '', room: '', showerId: -1, cardShown: '', type: 'SUGGESTION' };
        document.getElementById('submitBtn').innerText = 'Log Result';
        document.getElementById('cancelEditBtn').classList.add('hidden');
        window.switchTab('LOG');
    };

    window.deleteSuggestion = (index) => {
        if (confirm('Delete log?')) { suggestions.splice(index, 1); triggerSave(); render(); }
    };

    window.updatePlayerName = (id, v) => { 
        const p = players.find(x => x.id === String(id));
        if (p) p.name = v; triggerSave(); 
    };

    window.resetGame = () => { 
        if (confirm('Reset session?')) { 
            players = []; myCards = []; suggestions = []; gameState = 'SETUP'; currentTurnIdx = 0; manualOverrides = {};
            localStorage.removeItem(STORAGE_KEY); render(); 
        } 
    };

    window.updateFormSelection = () => {
        const fillGrid = (id, list, k) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = list.map(i => `<button class="btn-option ${String(tempSugg[k]) === String(i.id||i) ? 'active' : ''}" onclick="window.setSuggVal('${k}', '${i.id||i}')">${i.name||i}</button>`).join('');
        };
        fillGrid('suggesterOptions', players, 'suggesterId');
        fillGrid('suspectOptions', CATEGORIES.SUSPECTS, 'suspect');
        fillGrid('weaponOptions', CATEGORIES.WEAPONS, 'weapon');
        fillGrid('roomOptions', CATEGORIES.ROOMS, 'room');
        const showEl = document.getElementById('showerOptions');
        if (showEl) {
            let html = `<button class="btn-option ${tempSugg.showerId === -1 ? 'active' : ''}" onclick="window.setSuggVal('showerId', -1)">No One</button>`;
            players.forEach(p => { if (String(p.id) !== String(tempSugg.suggesterId)) html += `<button class="btn-option ${String(tempSugg.showerId) === String(p.id) ? 'active' : ''}" onclick="window.setSuggVal('showerId', '${p.id}')">${p.name}</button>`; });
            showEl.innerHTML = html;
        }
        const spec = document.getElementById('specificCardSection');
        if (spec) {
            if (tempSugg.showerId !== -1) {
                spec.classList.remove('hidden');
                const cards = [tempSugg.suspect, tempSugg.weapon, tempSugg.room].filter(Boolean);
                document.getElementById('shownCardOptions').innerHTML = `<button class="btn-option ${tempSugg.cardShown === '' ? 'active' : ''}" onclick="window.setSuggVal('cardShown', '')">Unknown</button>` + cards.map(c => `<button class="btn-option ${tempSugg.cardShown === c ? 'active' : ''}" onclick="window.setSuggVal('cardShown', '${c}')">${c}</button>`).join('');
            } else { spec.classList.add('hidden'); tempSugg.cardShown = ''; }
        }
    };

    // --- Deductions ---
    function calculateDeductions() {
        if (!players.length) return;
        ALL_CARDS.forEach(card => {
            gameDeductionMatrix[card] = {};
            players.forEach(p => {
                const isMe = players[0].id === p.id;
                const manual = manualOverrides[card]?.[p.id] || 0;
                if (manual !== 0) gameDeductionMatrix[card][p.id] = manual;
                else if (isMe) gameDeductionMatrix[card][p.id] = myCards.includes(card) ? 1 : -1;
                else gameDeductionMatrix[card][p.id] = myCards.includes(card) ? -1 : 0;
            });
        });

        const loop = () => {
            let changed = false;
            suggestions.filter(s => s.type === 'SUGGESTION').forEach(s => {
                const cards = [s.suspect, s.weapon, s.room];
                const suggIdx = players.findIndex(p => p.id === String(s.suggesterId));
                const showerIdx = s.showerId === -1 ? -1 : players.findIndex(p => p.id === String(s.showerId));
                if (suggIdx === -1) return;
                let curIdx = (suggIdx + 1) % players.length;
                const endIdx = s.showerId === -1 ? suggIdx : showerIdx;
                while (curIdx !== endIdx) {
                    const pId = players[curIdx].id;
                    cards.forEach(c => { if (gameDeductionMatrix[c][pId] !== -1) { gameDeductionMatrix[c][pId] = -1; changed = true; } });
                    curIdx = (curIdx + 1) % players.length;
                }
                if (s.cardShown && s.showerId !== -1) { if (gameDeductionMatrix[s.cardShown][s.showerId] !== 1) { gameDeductionMatrix[s.cardShown][s.showerId] = 1; changed = true; } }
                if (s.showerId !== -1 && !s.cardShown) {
                    const unknowns = cards.filter(c => gameDeductionMatrix[c][s.showerId] === 0);
                    const hasOne = cards.some(c => gameDeductionMatrix[c][s.showerId] === 1);
                    if (!hasOne && unknowns.length === 1) { gameDeductionMatrix[unknowns[0]][s.showerId] = 1; changed = true; }
                }
            });
            ALL_CARDS.forEach(c => {
                const owner = players.find(p => gameDeductionMatrix[c][p.id] === 1);
                if (owner) players.forEach(p => { if (p.id !== owner.id && gameDeductionMatrix[c][p.id] !== -1) { gameDeductionMatrix[c][p.id] = -1; changed = true; } });
            });
            players.forEach(p => {
                const confirmed = ALL_CARDS.filter(c => gameDeductionMatrix[c][p.id] === 1);
                const potential = ALL_CARDS.filter(c => gameDeductionMatrix[c][p.id] !== -1);
                if (p.cardCount > 0) {
                    if (confirmed.length === p.cardCount) ALL_CARDS.forEach(c => { if (gameDeductionMatrix[c][p.id] === 0) { gameDeductionMatrix[c][p.id] = -1; changed = true; } });
                    else if (potential.length === p.cardCount) potential.forEach(c => { if (gameDeductionMatrix[c][p.id] === 0) { gameDeductionMatrix[c][p.id] = 1; changed = true; } });
                }
            });
            Object.values(CATEGORIES).forEach(items => {
                const ruledOut = items.filter(c => players.every(p => gameDeductionMatrix[c][p.id] === -1));
                if (ruledOut.length === 0) {
                    const possible = items.filter(c => !players.some(p => gameDeductionMatrix[c][p.id] === 1));
                    if (possible.length === 1) players.forEach(p => { if (gameDeductionMatrix[possible[0]][p.id] !== -1) { gameDeductionMatrix[possible[0]][p.id] = -1; changed = true; } });
                }
            });
            return changed;
        };
        let limit = 40; while(loop() && limit-- > 0);
    }

    function getRecommendation() {
        if (!players.length) return { allFound: false };
        const findSol = (list) => list.find(c => players.every(p => gameDeductionMatrix[c][p.id] === -1));
        const sol = { suspect: findSol(CATEGORIES.SUSPECTS), weapon: findSol(CATEGORIES.WEAPONS), room: findSol(CATEGORIES.ROOMS) };
        const findBest = (list) => {
            let best = list[0], maxU = -1;
            list.forEach(c => { if (!myCards.includes(c)) { let u = players.filter((p, i) => i !== 0 && gameDeductionMatrix[c][p.id] === 0).length; if (u > maxU) { maxU = u; best = c; } } });
            return best;
        };
        return { suspect: sol.suspect || findBest(CATEGORIES.SUSPECTS), weapon: sol.weapon || findBest(CATEGORIES.WEAPONS), room: sol.room || findBest(CATEGORIES.ROOMS), allFound: !!(sol.suspect && sol.weapon && sol.room) };
    }

    // --- UI Render ---
    function render() {
        const fab = document.getElementById('mobileFab');
        if (fab) fab.style.display = (gameState === 'SETUP') ? 'none' : 'flex';

        if (gameState === 'SETUP') {
            document.getElementById('setupView').classList.remove('hidden');
            document.getElementById('playView').classList.add('hidden');
            renderSetup();
        } else {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('playView').classList.remove('hidden');
            calculateDeductions();
            document.getElementById('currentTurnNameDisplay').innerText = players[currentTurnIdx]?.name || 'Unknown';
            document.getElementById('turnStatusDot').style.background = currentTurnIdx === 0 ? 'var(--primary)' : '#94a3b8';
            renderBoard(); renderLog();
        }
    }

    function renderSetup() {
        const grid = document.getElementById('setupCardsGrid');
        grid.innerHTML = '';
        Object.entries(CATEGORIES).forEach(([cat, items]) => {
            const h3 = document.createElement('h3');
            h3.style.cssText = 'width:100%; font-size:10px; margin-top:16px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em;';
            h3.innerText = cat; grid.appendChild(h3);
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = `card-pill ${myCards.includes(item) ? 'selected' : ''}`;
                btn.innerText = item;
                btn.onclick = () => { myCards = myCards.includes(item) ? myCards.filter(c => c !== item) : [...myCards, item]; triggerSave(); renderSetup(); };
                grid.appendChild(btn);
            });
        });
        if (!document.getElementById('playerInputsContainer').children.length) {
            if (players.length) players.forEach(p => window.addPlayerInput(p.name, p.cardCount, p.id));
            else { window.addPlayerInput('Me', 6); window.addPlayerInput('Player 2', 6); window.addPlayerInput('Player 3', 6); }
        }
    }

    function renderBoard() {
        const findSol = (list) => list.find(c => players.every(p => gameDeductionMatrix[c][p.id] === -1));
        const sol = { suspect: findSol(CATEGORIES.SUSPECTS), weapon: findSol(CATEGORIES.WEAPONS), room: findSol(CATEGORIES.ROOMS) };
        const rec = getRecommendation();
        const recText = document.getElementById('recommendationText');
        if (currentTurnIdx === 0) document.getElementById('recommendationHeader').innerText = "Recommended for you";
        else document.getElementById('recommendationHeader').innerText = "Investigation Strategy";
        recText.innerHTML = rec.allFound ? `<span class="sugg-chip" style="background:rgba(16,185,129,0.2); color:var(--success);">CASE SOLVED!</span>` : `<span class="sugg-chip">${rec.suspect}</span> <span class="sugg-chip">${rec.weapon}</span> <span class="sugg-chip">${rec.room}</span>`;
        document.getElementById('solutionBanner').innerHTML = ['suspect', 'weapon', 'room'].map(k => `<div class="solution-card ${sol[k] ? 'found' : ''}"><div class="solution-label">${k}</div><div class="solution-value">${sol[k] || '?'}</div></div>`).join('');
        document.getElementById('tableHeader').innerHTML = '<th>Card</th>' + players.map(p => {
            const confirmed = ALL_CARDS.filter(c => gameDeductionMatrix[c][p.id] === 1).length;
            return `<th><div class="header-cell-content"><input type="text" class="header-edit" value="${p.name}" oninput="window.updatePlayerName('${p.id}', this.value)"><div class="card-count-indicator">${confirmed}/${p.cardCount}</div></div></th>`;
        }).join('');
        const body = document.getElementById('tableBody'); body.innerHTML = '';
        Object.entries(CATEGORIES).forEach(([cat, items]) => {
            body.innerHTML += `<tr class="category-row"><td colspan="${players.length+1}">${cat}</td></tr>`;
            items.forEach(item => {
                const isSol = Object.values(sol).includes(item);
                const isRec = currentTurnIdx === 0 && [rec.suspect, rec.weapon, rec.room].includes(item);
                let row = `<tr class="${isSol ? 'row-found' : ''} ${isRec ? 'row-recommended' : ''}"><td>${item}</td>`;
                players.forEach(p => {
                    const s = gameDeductionMatrix[item][p.id];
                    const icon = s === 1 ? 'check_circle' : (s === -1 ? 'cancel' : 'help_outline');
                    const man = manualOverrides[item]?.[p.id];
                    row += `<td class="deduction-cell ${man === 1 ? 'manual-yes' : (man === -1 ? 'manual-no' : '')}" onclick="window.toggleManualOverride('${item}', '${p.id}')"><div class="${s === 1 ? 'cell-yes' : (s === -1 ? 'cell-no' : 'cell-unknown')}"><span class="material-icons">${icon}</span></div></td>`;
                });
                body.innerHTML += row + '</tr>';
            });
        });
    }

    function renderLog() {
        const cont = document.getElementById('logContainer');
        if (!suggestions.length) return cont.innerHTML = `<p style="text-align:center; color:var(--text-muted); padding:30px; font-weight:700;">No history logged yet.</p>`;
        cont.innerHTML = suggestions.map((s, idx) => {
            const time = s.timestamp ? new Date(s.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const p = players.find(x => x.id === String(s.suggesterId))?.name || 'Someone';
            if (s.type === 'SKIP') return `<div class="log-item animate-in"><div class="log-header"><div class="log-who-wrap"><div class="log-who">${p} skipped turn</div><div class="log-timestamp">${time}</div></div><div class="log-actions"><button class="btn-log-action delete" onclick="window.deleteSuggestion(${idx})"><span class="material-icons">delete_outline</span></button></div></div></div>`;
            const sh = s.showerId === -1 ? 'No one' : players.find(x => x.id === String(s.showerId))?.name || 'Someone';
            return `<div class="log-item animate-in"><div class="log-header"><div class="log-who-wrap"><div class="log-who">${p} inquired:</div><div class="log-timestamp">${time}</div></div><div class="log-actions"><button class="btn-log-action" onclick="window.editSuggestion(${idx})"><span class="material-icons">edit</span></button><button class="btn-log-action delete" onclick="window.deleteSuggestion(${idx})"><span class="material-icons">delete_outline</span></button></div></div><div class="log-tag-group"><span class="log-badge">${s.suspect}</span><span class="log-badge">${s.weapon}</span><span class="log-badge">${s.room}</span></div><div class="log-result">${sh} showed card${s.cardShown ? ` (${s.cardShown})` : ''}</div></div>`;
        }).reverse().join('');
    }

    window.onload = loadState;
</script>
</body>
</html>
