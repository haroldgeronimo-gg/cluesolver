<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Clue Solver Pro | Master Detective</title>
    
    <!-- Material Symbols Outlined - Modern & Reliable -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --p: #6366f1;
            --p-light: #818cf8;
            --p-dark: #4f46e5;
            --acc: #f43f5e;
            --succ: #10b981;
            --warn: #f59e0b;
            --bg: #f8fafc;
            --card: rgba(255, 255, 255, 0.7);
            --border: rgba(0, 0, 0, 0.08);
            --text: #0f172a;
            --text-m: #64748b;
            --glass: blur(20px);
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
            --radius: 28px;
            --radius-s: 16px;
            --subtle: rgba(0, 0, 0, 0.04);
            --input-bg: rgba(255, 255, 255, 0.5);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .dark-mode {
            --bg: #020617;
            --card: rgba(15, 23, 42, 0.7);
            --border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-m: #94a3b8;
            --shadow: 0 20px 50px -12px rgba(0,0,0,0.5);
            --subtle: rgba(255, 255, 255, 0.06);
            --input-bg: rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; padding: 0; 
            background: var(--bg); color: var(--text);
            min-height: 100vh; overflow-x: hidden;
            transition: background 0.5s ease;
        }

        .mesh {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.12) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(244, 63, 94, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.08) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(245, 158, 11, 0.08) 0px, transparent 50%);
            filter: blur(100px);
        }

        .glass {
            background: var(--card);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: all 0.4s var(--spring);
        }

        .container { 
            max-width: 1100px; margin: 0 auto; 
            padding: calc(20px + var(--safe-top)) 16px calc(100px + var(--safe-bottom)); 
        }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .logo h1 { font-size: 1.6rem; font-weight: 900; margin: 0; letter-spacing: -1.5px; }
        .logo span { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--p); font-weight: 800; display: block; margin-bottom: -4px; }
        
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { 
            width: 44px; height: 44px; border-radius: 14px; 
            background: var(--card); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            color: var(--text); cursor: pointer; transition: 0.3s var(--spring);
        }
        .icon-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px -5px rgba(0,0,0,0.1); }
        .icon-btn:active { transform: scale(0.9); }
        .icon-btn.active { background: var(--p); color: white; border-color: var(--p); }

        .setup-grid { display: grid; gap: 24px; grid-template-columns: 1fr; }
        @media (min-width: 850px) { .setup-grid { grid-template-columns: 1fr 1.2fr; } }

        .section-label { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; color: var(--text-m); margin-bottom: 12px; display: block; letter-spacing: 1px; }

        .player-row { 
            display: flex; align-items: center; gap: 12px; 
            background: var(--input-bg); border-radius: var(--radius-s);
            padding: 10px 14px; margin-bottom: 8px; border: 1px solid var(--border);
            animation: slideIn 0.3s var(--spring);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .player-row input { 
            background: transparent; border: none; color: var(--text); font-family: inherit;
            font-weight: 700; font-size: 1rem; flex: 1;
        }
        .player-row .card-count { width: 44px; text-align: center; color: var(--p); font-weight: 800; border-radius: 8px; background: var(--subtle); padding: 4px; }

        .recommendation-banner { 
            margin-bottom: 24px; padding: 20px; border: 1px solid var(--border);
            background: var(--card); overflow: hidden; position: relative;
        }
        .recommendation-banner::after {
            content: 'INTELLIGENCE BRIEFING';
            position: absolute; top: 10px; right: 10px; font-size: 0.5rem;
            font-weight: 900; color: var(--p); opacity: 0.5;
        }
        .rec-trio {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;
        }
        .rec-card {
            background: var(--subtle); padding: 12px; border-radius: 16px; text-align: center;
            border: 1px solid transparent; transition: 0.2s var(--spring); cursor: pointer;
        }
        .rec-card:hover { border-color: var(--p); transform: translateY(-3px); background: var(--card); }
        .rec-card .emoji { font-size: 1.4rem; display: block; margin-bottom: 4px; }
        .rec-card .name { font-size: 0.75rem; font-weight: 800; display: block; }
        .rec-card .utility { font-size: 0.6rem; font-weight: 900; color: var(--p); text-transform: uppercase; margin-top: 4px; display: block; }

        .solution-shelf { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; position: relative; }
        .solution-item { padding: 18px; text-align: center; border: 2px dashed var(--border); transition: 0.5s var(--spring); }
        .solution-item.solved { border-style: solid; border-color: var(--succ); background: rgba(16, 185, 129, 0.08); transform: scale(1.02); }
        .solution-item .val { font-weight: 800; font-size: 0.9rem; display: block; margin-top: 6px; }
        .solution-item .emoji { font-size: 1.5rem; margin-bottom: 4px; display: block; }

        /* Privacy Mode Styles */
        .privacy-blur {
            filter: blur(25px) !important;
            opacity: 0.3 !important;
            pointer-events: none !important;
            user-select: none !important;
        }

        .privacy-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 100; text-align: center;
            color: var(--text-m);
        }

        .table-container { 
            overflow-x: auto; -webkit-overflow-scrolling: touch; 
            border-radius: var(--radius); border: 1px solid var(--border);
            margin-bottom: 24px; position: relative;
        }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        th, td { padding: 16px 14px; text-align: center; border-bottom: 1px solid var(--border); color: var(--text); }
        td:first-child, th:first-child { 
            text-align: left; position: sticky; left: 0; background: var(--card); 
            backdrop-filter: var(--glass); z-index: 10; font-weight: 700; width: 180px;
            border-right: 1px solid var(--border);
        }
        th { background: var(--subtle); font-size: 0.65rem; text-transform: uppercase; color: var(--text-m); letter-spacing: 1.2px; font-weight: 900; }

        .status-cell { cursor: pointer; transition: 0.2s var(--spring); }
        .status-cell:active { transform: scale(0.8); }
        .status-cell.confirmed { color: var(--succ); }
        .status-cell.ruled-out { color: var(--acc); opacity: 0.25; }

        .bottom-nav { 
            position: fixed; bottom: var(--safe-bottom); left: 50%; transform: translateX(-50%);
            width: calc(100% - 32px); max-width: 600px; height: 80px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding: 0 12px;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            color: var(--text-m); cursor: pointer; transition: 0.3s var(--spring); flex: 1;
            padding: 10px 0; border-radius: 16px;
        }
        .nav-item.active { color: var(--p); background: var(--subtle); }
        .nav-item .material-symbols-outlined { font-size: 26px; }
        .nav-item span { font-size: 0.65rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; }

        .choice-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .choice-chip { 
            padding: 14px 10px; border-radius: 18px; border: 1.5px solid var(--border);
            background: var(--input-bg); font-size: 0.85rem; font-weight: 800; text-align: center;
            transition: 0.3s var(--spring); cursor: pointer; color: var(--text);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .choice-chip.active { border-color: var(--p); background: var(--p); color: white; transform: translateY(-4px); box-shadow: 0 8px 15px -5px rgba(99, 102, 241, 0.4); }

        .btn { 
            width: 100%; padding: 20px; border-radius: 20px; border: none; font-family: inherit;
            font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.3s var(--spring);
            display: flex; align-items: center; justify-content: center; gap: 12px;
        }
        .btn-p { background: var(--p); color: white; box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4); }
        .btn-acc { background: var(--acc); color: white; margin-top: 12px; box-shadow: 0 10px 25px -5px rgba(244, 63, 94, 0.3); }
        .btn-subtle { background: var(--subtle); color: var(--text); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s var(--spring) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        #syncToast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 24px; border-radius: 24px; background: var(--succ); color: white;
            font-size: 0.8rem; font-weight: 900; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.4s var(--spring);
        }
        #syncToast.show { opacity: 1; top: 35px; }

        .card-editor-row {
            display: grid; grid-template-columns: 50px 1fr 50px; gap: 10px; margin-bottom: 10px;
        }
        .card-editor-row input {
            background: var(--subtle); border: 1px solid var(--border); padding: 10px;
            border-radius: 12px; color: var(--text); font-family: inherit; font-weight: 700;
        }
    </style>
</head>
<body>

<div class="mesh"></div>
<div id="syncToast">Progress Secured</div>

<div class="container" id="app">
    <!-- SETUP VIEW -->
    <div id="setupView" class="fade-in">
        <header>
            <div class="logo">
                <span>The Ultimate Deduction Tool</span>
                <h1>CLUE SOLVER PRO</h1>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme"><span class="material-symbols-outlined">brightness_6</span></button>
            </div>
        </header>

        <div class="setup-grid">
            <div class="glass" style="padding: 24px;">
                <span class="section-label">1. Investigation Team</span>
                <div id="playerList"></div>
                <button class="btn btn-subtle" style="margin-top: 12px;" onclick="addPlayer()">
                    <span class="material-symbols-outlined">person_add</span> Add Player
                </button>

                <div style="margin-top: 32px;">
                    <span class="section-label">2. Mystery Management</span>
                    <button class="btn btn-subtle" style="margin-bottom: 12px;" onclick="toggleCardEditor()">
                        <span class="material-symbols-outlined">edit_note</span> Customize Cards
                    </button>
                    <button class="btn btn-p" onclick="startGame()">
                        <span class="material-symbols-outlined">play_arrow</span> Start Investigation
                    </button>
                </div>
            </div>

            <div class="glass" style="padding: 24px;">
                <span class="section-label">3. Your Secret Hand</span>
                <p style="font-size: 0.8rem; color: var(--text-m); margin-bottom: 24px; font-weight: 500;">Toggle the cards you currently hold in your hand.</p>
                <div id="handGrid"></div>
            </div>
        </div>
    </div>

    <!-- CARD EDITOR -->
    <div id="cardEditor" class="hidden fade-in" style="margin-bottom: 24px;">
        <div class="glass" style="padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span class="section-label" style="margin: 0">Customize Investigation Assets</span>
                <button class="icon-btn" onclick="toggleCardEditor()" style="width: 36px; height: 36px;"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div id="editorContent"></div>
        </div>
    </div>

    <!-- PLAY VIEW -->
    <div id="playView" class="hidden">
        <div id="tab-BOARD" class="fade-in">
            <header>
                <div class="logo">
                    <span>Active Detective</span>
                    <h1 id="activePlayerName">Detective</h1>
                </div>
                <div class="header-actions">
                    <!-- Toggle Privacy Mode -->
                    <button id="privacyToggle" class="icon-btn" onclick="togglePrivacy()" title="Privacy Mode">
                        <span class="material-symbols-outlined">visibility</span>
                    </button>
                    <button class="icon-btn" onclick="adjustTurn(-1)"><span class="material-symbols-outlined">arrow_back_ios_new</span></button>
                    <button class="icon-btn" onclick="adjustTurn(1)"><span class="material-symbols-outlined">arrow_forward_ios</span></button>
                </div>
            </header>

            <!-- Solution Shelf wrapper for privacy -->
            <div id="solutionWrapper" style="position: relative;">
                <div class="solution-shelf" id="solutionShelf"></div>
            </div>

            <!-- Recommendation wrapper for privacy -->
            <div id="recWrapper" style="position: relative;">
                <div class="glass recommendation-banner" id="recBanner">
                    <span class="section-label" style="margin:0">Suggested Inquiry for your turn</span>
                    <div id="recContainer" class="rec-trio"></div>
                </div>
            </div>

            <div class="table-container glass" id="matrixWrapper">
                <table id="deductionTable">
                    <thead><tr id="tableHead"></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-LOG" class="hidden fade-in">
            <span class="section-label">Historical Data</span>
            <div id="logList"></div>
        </div>

        <div id="tab-NEW" class="hidden fade-in">
            <div class="glass" style="padding: 24px;">
                <div class="form-group">
                    <span class="section-label">Origin of Inquiry</span>
                    <div id="suggesterChoices" class="choice-grid"></div>
                </div>

                <div class="form-group">
                    <span class="section-label">Suspect</span>
                    <div id="suspectChoices" class="choice-grid"></div>
                </div>
                <div class="form-group">
                    <span class="section-label">Weapon</span>
                    <div id="weaponChoices" class="choice-grid"></div>
                </div>
                <div class="form-group">
                    <span class="section-label">Room</span>
                    <div id="roomChoices" class="choice-grid"></div>
                </div>

                <div class="form-group">
                    <span class="section-label">Reveal Result</span>
                    <div id="showerChoices" class="choice-grid"></div>
                </div>

                <div id="cardShownSection" class="form-group hidden">
                    <span class="section-label">Revealed Asset</span>
                    <div id="shownChoices" class="choice-grid"></div>
                </div>

                <div style="display: grid; gap: 14px;">
                    <button class="btn btn-p" onclick="submitInquiry()">
                        <span class="material-symbols-outlined">playlist_add_check</span> Log Investigation Result
                    </button>
                    <button class="btn btn-acc" onclick="submitFailedAccusation()">
                        <span class="material-symbols-outlined">gavel</span> Failed Accusation Report
                    </button>
                    <button class="btn btn-subtle" onclick="skipTurn()">
                        <span class="material-symbols-outlined">skip_next</span> Pass Turn
                    </button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav glass">
            <div class="nav-item active" id="nav-BOARD" onclick="switchTab('BOARD')">
                <span class="material-symbols-outlined">dashboard</span>
                <span>Matrix</span>
            </div>
            <div class="nav-item" id="nav-NEW" onclick="switchTab('NEW')">
                <span class="material-symbols-outlined">add_circle</span>
                <span>New Log</span>
            </div>
            <div class="nav-item" id="nav-LOG" onclick="switchTab('LOG')">
                <span class="material-symbols-outlined">history</span>
                <span>History</span>
            </div>
            <div class="nav-item" onclick="resetGame()">
                <span class="material-symbols-outlined" style="color: var(--acc)">restart_alt</span>
                <span>Clear</span>
            </div>
        </nav>
    </div>
</div>

<script>
    const DEFAULT_CATEGORIES = {
        SUSPECTS: [
            { name: 'Miss Scarlett', emoji: 'ðŸ’ƒ' },
            { name: 'Col. Mustard', emoji: 'ðŸŽ–ï¸' },
            { name: 'Dr. Orchid', emoji: 'ðŸ”¬' },
            { name: 'Mr. Green', emoji: 'ðŸ’¹' },
            { name: 'Mrs. Peacock', emoji: 'ðŸ¦š' },
            { name: 'Prof. Plum', emoji: 'ðŸŽ“' }
        ],
        WEAPONS: [
            { name: 'Candlestick', emoji: 'ðŸ•¯ï¸' },
            { name: 'Dagger', emoji: 'ðŸ—¡ï¸' },
            { name: 'Lead Pipe', emoji: 'ðŸ”§' },
            { name: 'Revolver', emoji: 'ðŸ”«' },
            { name: 'Rope', emoji: 'ðŸª¢' },
            { name: 'Wrench', emoji: 'ðŸ› ï¸' }
        ],
        ROOMS: [
            { name: 'Kitchen', emoji: 'ðŸ³' },
            { name: 'Ballroom', emoji: 'ðŸ’ƒ' },
            { name: 'Conservatory', emoji: 'ðŸª´' },
            { name: 'Billiard Room', emoji: 'ðŸŽ±' },
            { name: 'Library', emoji: 'ðŸ“š' },
            { name: 'Study', emoji: 'ðŸ–‹ï¸' },
            { name: 'Hall', emoji: 'ðŸšª' },
            { name: 'Lounge', emoji: 'ðŸ›‹ï¸' },
            { name: 'Dining Room', emoji: 'ðŸ·' }
        ]
    };

    let state = {
        players: [
            { id: '1', name: 'You', cards: 6 },
            { id: '2', name: 'Player 2', cards: 6 },
            { id: '3', name: 'Player 3', cards: 6 }
        ],
        categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
        myHand: [],
        logs: [],
        manual: {},
        turnIdx: 0,
        mode: 'light',
        view: 'SETUP',
        privacy: false
    };

    let tempEntry = { suggesterId: null, suspect: '', weapon: '', room: '', showerId: null, cardShown: '' };

    const getCardByName = (name) => [...state.categories.SUSPECTS, ...state.categories.WEAPONS, ...state.categories.ROOMS].find(c => c.name === name);
    const getAllCardNames = () => [...state.categories.SUSPECTS, ...state.categories.WEAPONS, ...state.categories.ROOMS].map(c => c.name);

    function save() {
        localStorage.setItem('clue_pro_ultra_state', JSON.stringify(state));
        const toast = document.getElementById('syncToast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function load() {
        const saved = localStorage.getItem('clue_pro_ultra_state');
        if (saved) {
            const parsed = JSON.parse(saved);
            state = parsed;
            if (state.mode === 'dark') document.body.classList.add('dark-mode');
        }
        render();
    }

    function render() {
        if (state.view === 'SETUP') {
            document.getElementById('setupView').classList.remove('hidden');
            document.getElementById('playView').classList.add('hidden');
            renderSetup();
        } else {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('playView').classList.remove('hidden');
            renderBoard();
        }
    }

    function renderSetup() {
        const list = document.getElementById('playerList');
        list.innerHTML = state.players.map(p => `
            <div class="player-row">
                <input type="text" value="${p.name}" onchange="updatePlayer('${p.id}', 'name', this.value)">
                <span class="section-label" style="margin:0">Hand Size:</span>
                <input type="number" class="card-count" value="${p.cards}" onchange="updatePlayer('${p.id}', 'cards', this.value)">
                <span class="material-symbols-outlined" style="color:var(--acc); cursor:pointer; font-size:24px" onclick="removePlayer('${p.id}')">remove_circle</span>
            </div>
        `).join('');

        const hand = document.getElementById('handGrid');
        hand.innerHTML = '';
        Object.entries(state.categories).forEach(([cat, cards]) => {
            const h = document.createElement('div');
            h.innerHTML = `<span class="section-label">${cat}</span>`;
            const grid = document.createElement('div');
            grid.className = 'choice-grid';
            grid.style.marginBottom = '24px';
            cards.forEach(c => {
                const active = state.myHand.includes(c.name);
                grid.innerHTML += `<div class="choice-chip ${active ? 'active' : ''}" onclick="toggleHand('${c.name}')"><span class="emoji">${c.emoji}</span><span>${c.name}</span></div>`;
            });
            hand.appendChild(h);
            hand.appendChild(grid);
        });
    }

    function renderBoard() {
        const matrix = solve();
        const p = state.players[state.turnIdx];
        document.getElementById('activePlayerName').innerText = p.name;
        
        // Handle Privacy Mode UI State
        const pt = document.getElementById('privacyToggle');
        const icon = state.privacy ? 'visibility_off' : 'visibility';
        pt.innerHTML = `<span class="material-symbols-outlined">${icon}</span>`;
        pt.classList.toggle('active', state.privacy);

        // Apply Privacy Blur
        ['solutionShelf', 'recBanner', 'deductionTable'].forEach(id => {
            document.getElementById(id).classList.toggle('privacy-blur', state.privacy);
        });

        // Add/Remove Privacy Overlays
        ['solutionWrapper', 'recWrapper', 'matrixWrapper'].forEach(id => {
            const wrap = document.getElementById(id);
            const existing = wrap.querySelector('.privacy-overlay');
            if (state.privacy && !existing) {
                const overlay = document.createElement('div');
                overlay.className = 'privacy-overlay';
                overlay.innerHTML = `
                    <span class="material-symbols-outlined" style="font-size:32px; margin-bottom:8px">lock</span>
                    <span style="font-weight:800; font-size:0.8rem">SENSITIVE DATA HIDDEN</span>
                    <span style="font-size:0.6rem; opacity:0.7">Tap the eye icon to reveal</span>
                `;
                wrap.appendChild(overlay);
            } else if (!state.privacy && existing) {
                existing.remove();
            }
        });

        const shelf = document.getElementById('solutionShelf');
        shelf.innerHTML = '';
        Object.entries(state.categories).forEach(([cat, list]) => {
            const solName = list.map(i => i.name).find(c => state.players.every(p => matrix[c] && matrix[c][p.id] === -1));
            const solData = solName ? getCardByName(solName) : null;
            shelf.innerHTML += `<div class="glass solution-item ${solData ? 'solved' : ''}"><span class="section-label" style="font-size:0.6rem; margin-bottom:8px">${cat.slice(0,-1)}</span><span class="emoji">${solData ? solData.emoji : 'ðŸ”Ž'}</span><span class="val">${solData ? solData.name : 'Unknown'}</span></div>`;
        });

        const getBestCard = (cards) => {
            return cards.map(c => {
                const utility = state.players.slice(1).filter(p => matrix[c.name][p.id] === 0).length;
                const isSolution = state.players.every(p => matrix[c.name][p.id] === -1);
                const score = isSolution ? -1 : utility;
                return { ...c, score };
            }).sort((a,b) => b.score - a.score)[0];
        };

        const recContainer = document.getElementById('recContainer');
        const bestSuspect = getBestCard(state.categories.SUSPECTS);
        const bestWeapon = getBestCard(state.categories.WEAPONS);
        const bestRoom = getBestCard(state.categories.ROOMS);

        recContainer.innerHTML = [bestSuspect, bestWeapon, bestRoom].map(c => `
            <div class="rec-card" onclick="useRecommendation('${bestSuspect.name}', '${bestWeapon.name}', '${bestRoom.name}')">
                <span class="emoji">${c.emoji}</span>
                <span class="name">${c.name}</span>
                <span class="utility">${c.score > 0 ? `+${c.score} Targets` : 'Known'}</span>
            </div>
        `).join('');

        const head = document.getElementById('tableHead');
        head.innerHTML = '<th>Matrix</th>' + state.players.map(p => `<th>${p.name}</th>`).join('');
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        Object.entries(state.categories).forEach(([cat, list]) => {
            body.innerHTML += `<tr><td colspan="${state.players.length+1}" style="background:var(--subtle); font-size:0.65rem; text-transform:uppercase; font-weight:900; color:var(--p); padding:10px 14px">${cat}</td></tr>`;
            list.forEach(c => {
                const isSol = state.players.every(p => matrix[c.name] && matrix[c.name][p.id] === -1);
                let row = `<tr style="${isSol ? 'background:rgba(16,185,129,0.04)' : ''}"><td><div style="display:flex;align-items:center;gap:10px"><span style="font-size:1.2rem">${c.emoji}</span><span>${c.name}</span></div></td>`;
                state.players.forEach(p => {
                    const val = matrix[c.name][p.id];
                    const icon = val === 1 ? 'check_circle' : (val === -1 ? 'cancel' : 'help_outline');
                    row += `<td class="status-cell ${val === 1 ? 'confirmed' : (val === -1 ? 'ruled-out' : '')}" onclick="toggleManual('${c.name}', '${p.id}')"><span class="material-symbols-outlined">${icon}</span></td>`;
                });
                body.innerHTML += row + '</tr>';
            });
        });
        renderLogs();
    }

    function togglePrivacy() {
        state.privacy = !state.privacy;
        render();
    }

    function useRecommendation(s, w, r) {
        if (state.privacy) return;
        switchTab('NEW');
        tempEntry.suspect = s;
        tempEntry.weapon = w;
        tempEntry.room = r;
        updateFormUI();
    }

    function solve() {
        const matrix = {};
        const allCards = getAllCardNames();
        allCards.forEach(c => {
            matrix[c] = {};
            state.players.forEach(p => {
                const manual = state.manual[c]?.[p.id];
                if (manual) matrix[c][p.id] = manual;
                else if (p.id === state.players[0].id) matrix[c][p.id] = state.myHand.includes(c) ? 1 : -1;
                else matrix[c][p.id] = state.myHand.includes(c) ? -1 : 0;
            });
        });

        let changed = true;
        let limit = 25;
        while (changed && limit-- > 0) {
            changed = false;
            state.logs.forEach(log => {
                if (log.type === 'INQUIRY') {
                    const cards = [log.suspect, log.weapon, log.room];
                    const sIdx = state.players.findIndex(p => p.id === log.suggesterId);
                    const shIdx = log.showerId ? state.players.findIndex(p => p.id === log.showerId) : -1;
                    if (sIdx !== -1) {
                        let cur = (sIdx + 1) % state.players.length;
                        const end = log.showerId ? shIdx : sIdx;
                        while (cur !== end) {
                            cards.forEach(c => { if (matrix[c] && matrix[c][state.players[cur].id] !== -1) { matrix[c][state.players[cur].id] = -1; changed = true; } });
                            cur = (cur + 1) % state.players.length;
                        }
                    }
                    if (log.cardShown && log.showerId && matrix[log.cardShown]) { if (matrix[log.cardShown][log.showerId] !== 1) { matrix[log.cardShown][log.showerId] = 1; changed = true; } }
                }
            });
            allCards.forEach(c => {
                const owner = state.players.find(p => matrix[c][p.id] === 1);
                if (owner) state.players.forEach(p => { if (p.id !== owner.id && matrix[c][p.id] !== -1) { matrix[c][p.id] = -1; changed = true; } });
            });
            Object.values(state.categories).forEach(list => {
                const names = list.map(i => i.name);
                const potential = names.filter(c => !state.players.some(p => matrix[c][p.id] === 1));
                if (potential.length === 1) state.players.forEach(p => { if (matrix[potential[0]][p.id] !== -1) { matrix[potential[0]][p.id] = -1; changed = true; } });
            });
        }
        return matrix;
    }

    function renderLogs() {
        const list = document.getElementById('logList');
        if (state.logs.length === 0) return list.innerHTML = `<div style="text-align:center; padding:60px; opacity:0.3">No Records Found</div>`;
        list.innerHTML = state.logs.map((l, i) => {
            const isAcc = l.type === 'ACCUSATION';
            return `<div class="glass log-card fade-in ${isAcc ? 'log-acc' : ''}">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span class="section-label" style="color:var(${isAcc ? '--acc' : '--p'})">${isAcc ? 'FAILED ACCUSATION' : 'INVESTIGATION'}</span><span class="material-symbols-outlined" style="cursor:pointer; font-size:18px" onclick="deleteLog(${i})">delete</span></div>
                <div style="font-weight:800; margin-bottom:8px">${l.suspect}, ${l.weapon}, ${l.room}</div>
                <div style="font-size:0.75rem; opacity:0.7">${isAcc ? 'Confirmed incorrect.' : `${state.players.find(x => x.id === l.showerId)?.name || 'None'} showed a card.`}</div>
            </div>`;
        }).reverse().join('');
    }

    function addPlayer() { state.players.push({ id: Date.now().toString(), name: `Detective ${state.players.length + 1}`, cards: 6 }); renderSetup(); }
    function removePlayer(id) { state.players = state.players.filter(p => p.id !== id); renderSetup(); }
    function startGame() { if (state.players.length < 2) return Swal.fire('Team Required', 'Add at least 2 players.', 'info'); state.view = 'PLAYING'; state.turnIdx = 0; save(); render(); }
    function switchTab(tab) { ['BOARD', 'LOG', 'NEW'].forEach(t => { document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab); document.getElementById(`nav-${t}`).classList.toggle('active', t === tab); }); if (tab === 'NEW') prepareForm(); }
    function toggleTheme() { state.mode = state.mode === 'light' ? 'dark' : 'light'; document.body.classList.toggle('dark-mode'); save(); }
    function toggleCardEditor() { const editor = document.getElementById('cardEditor'); editor.classList.toggle('hidden'); if (!editor.classList.contains('hidden')) renderCardEditor(); }
    function renderCardEditor() {
        const content = document.getElementById('editorContent'); content.innerHTML = '';
        Object.entries(state.categories).forEach(([catKey, items]) => {
            const h = document.createElement('div'); h.innerHTML = `<span class="section-label" style="margin-top:20px">${catKey}</span>`; content.appendChild(h);
            items.forEach((item, idx) => {
                content.innerHTML += `<div class="card-editor-row"><input type="text" value="${item.emoji}" onchange="updateCard('${catKey}', ${idx}, 'emoji', this.value)" style="text-align:center"><input type="text" value="${item.name}" onchange="updateCard('${catKey}', ${idx}, 'name', this.value)"><button class="icon-btn" onclick="removeCard('${catKey}', ${idx})" style="width:100%; height:100%; color:var(--acc)"><span class="material-symbols-outlined">delete</span></button></div>`;
            });
            const addBtn = document.createElement('button'); addBtn.className = 'btn btn-subtle'; addBtn.style.padding = '10px'; addBtn.innerHTML = `<span class="material-symbols-outlined">add</span> Add ${catKey.slice(0,-1)}`;
            addBtn.onclick = () => { state.categories[catKey].push({ name: 'New Item', emoji: 'â“' }); renderCardEditor(); };
            content.appendChild(addBtn);
        });
    }

    function updateCard(cat, idx, key, val) { const oldName = state.categories[cat][idx].name; state.categories[cat][idx][key] = val; if (key === 'name') { if (state.myHand.includes(oldName)) state.myHand = state.myHand.map(n => n === oldName ? val : n); if (state.manual[oldName]) { state.manual[val] = state.manual[oldName]; delete state.manual[oldName]; } } save(); }
    function removeCard(cat, idx) { state.categories[cat].splice(idx, 1); renderCardEditor(); save(); }
    function toggleHand(n) { state.myHand = state.myHand.includes(n) ? state.myHand.filter(c => c !== n) : [...state.myHand, n]; renderSetup(); }
    function updatePlayer(id, k, v) { const p = state.players.find(x => x.id === id); if (p) p[k] = k === 'cards' ? parseInt(v) : v; save(); }
    function toggleManual(c, p) { if (!state.manual[c]) state.manual[c] = {}; state.manual[c][p] = state.manual[c][p] === 1 ? -1 : (state.manual[c][p] === -1 ? 0 : 1); save(); render(); }
    function deleteLog(i) { state.logs.splice(i, 1); save(); render(); }
    function adjustTurn(d) { state.turnIdx = (state.turnIdx + d + state.players.length) % state.players.length; render(); }
    function resetGame() { Swal.fire({ title: 'Reset Case?', text: 'All data will be erased.', icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--acc)', confirmButtonText: 'Reset' }).then(r => { if (r.isConfirmed) { localStorage.removeItem('clue_pro_ultra_state'); location.reload(); } }); }
    
    function prepareForm() { tempEntry = { ...tempEntry, type: 'INQUIRY', suggesterId: state.players[state.turnIdx].id }; if (!tempEntry.suspect) { tempEntry.suspect = state.categories.SUSPECTS[0].name; tempEntry.weapon = state.categories.WEAPONS[0].name; tempEntry.room = state.categories.ROOMS[0].name; } updateFormUI(); }
    function updateFormUI() {
        const fill = (id, list, key, isPlayer = false, isCard = false) => {
            const el = document.getElementById(id); el.innerHTML = '';
            list.forEach(i => { const val = isPlayer ? i.id : (isCard ? i.name : i); el.innerHTML += `<div class="choice-chip ${tempEntry[key] === val ? 'active' : ''}" onclick="setFormVal('${key}', '${val}')">${isCard ? `<span style="font-size:1.2rem">${i.emoji}</span>` : ''}<span>${i.name || i}</span></div>`; });
        };
        fill('suggesterChoices', state.players, 'suggesterId', true);
        fill('suspectChoices', state.categories.SUSPECTS, 'suspect', false, true);
        fill('weaponChoices', state.categories.WEAPONS, 'weapon', false, true);
        fill('roomChoices', state.categories.ROOMS, 'room', false, true);
        const showers = [{id: null, name: 'No One'}, ...state.players.filter(p => p.id !== tempEntry.suggesterId)];
        fill('showerChoices', showers, 'showerId', true);
        const cardSection = document.getElementById('cardShownSection');
        if (tempEntry.showerId && tempEntry.showerId !== 'null') {
            cardSection.classList.remove('hidden'); const possible = [tempEntry.suspect, tempEntry.weapon, tempEntry.room].map(n => getCardByName(n));
            const container = document.getElementById('shownChoices'); container.innerHTML = [{name:'?', emoji:'ðŸ”Ž'}, ...possible].map(c => `<div class="choice-chip ${tempEntry.cardShown === (c.name==='?'?'':c.name) ? 'active' : ''}" onclick="setFormVal('cardShown', '${c.name==='?'?'':c.name}')"><span style="font-size:1.2rem">${c.emoji}</span><span>${c.name}</span></div>`).join('');
        } else { cardSection.classList.add('hidden'); tempEntry.cardShown = ''; }
    }
    window.setFormVal = (k, v) => { tempEntry[k] = v === 'null' ? null : v; updateFormUI(); };
    function submitInquiry() { state.logs.push({...tempEntry, type: 'INQUIRY', timestamp: Date.now()}); state.turnIdx = (state.turnIdx + 1) % state.players.length; save(); switchTab('BOARD'); render(); }
    function submitFailedAccusation() { state.logs.push({...tempEntry, type: 'ACCUSATION', timestamp: Date.now()}); save(); switchTab('BOARD'); render(); }
    function skipTurn() { state.turnIdx = (state.turnIdx + d + state.players.length) % state.players.length; save(); switchTab('BOARD'); render(); }
    
    window.onload = load;
</script>
</body>
</html>
